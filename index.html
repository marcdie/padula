<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Immobili Padula</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React e ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Lucide PRIMA del codice React che lo usa -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Immobili Padula">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Simulazione di window.storage per GitHub Pages
        const storage = {
            async get(key) {
                const value = localStorage.getItem(key);
                return value ? { key, value, shared: false } : null;
            },
            async set(key, value) {
                localStorage.setItem(key, value);
                return { key, value, shared: false };
            },
            async delete(key) {
                localStorage.removeItem(key);
                return { key, deleted: true, shared: false };
            },
            async list(prefix) {
                const keys = Object.keys(localStorage).filter(k => !prefix || k.startsWith(prefix));
                return { keys, prefix, shared: false };
            }
        };
        window.storage = storage;

        const GestioneImmobiliPadula = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [immobili, setImmobili] = useState([]);
            const [inquilini, setInquilini] = useState([]);
            const [pagamenti, setPagamenti] = useState([]);
            const [spese, setSpese] = useState([]);
            const [showModal, setShowModal] = useState(false);
            const [modalType, setModalType] = useState('');
            const [editingItem, setEditingItem] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                loadData();
            }, []);

            const loadData = async () => {
                try {
                    const [immobiliData, inquiliniData, pagamentiData, speseData] = await Promise.all([
                        window.storage.get('immobili').catch(() => null),
                        window.storage.get('inquilini').catch(() => null),
                        window.storage.get('pagamenti').catch(() => null),
                        window.storage.get('spese').catch(() => null)
                    ]);

                    if (immobiliData) setImmobili(JSON.parse(immobiliData.value));
                    if (inquiliniData) setInquilini(JSON.parse(inquiliniData.value));
                    if (pagamentiData) setPagamenti(JSON.parse(pagamentiData.value));
                    if (speseData) setSpese(JSON.parse(speseData.value));
                } catch (error) {
                    console.error('Errore caricamento:', error);
                } finally {
                    setLoading(false);
                }
            };

            const saveData = async (key, data) => {
                try {
                    await window.storage.set(key, JSON.stringify(data));
                } catch (error) {
                    console.error('Errore salvataggio:', error);
                    alert('Errore nel salvataggio dei dati');
                }
            };

            const openModal = (type, item = null) => {
                setModalType(type);
                setEditingItem(item);
                setShowModal(true);
            };

            const closeModal = () => {
                setShowModal(false);
                setEditingItem(null);
            };

            const handleSaveImmobile = async (formData) => {
                const newImmobile = {
                    id: editingItem?.id || Date.now().toString(),
                    ...formData,
                    createdAt: editingItem?.createdAt || new Date().toISOString()
                };

                let updatedImmobili;
                if (editingItem) {
                    updatedImmobili = immobili.map(i => i.id === editingItem.id ? newImmobile : i);
                } else {
                    updatedImmobili = [...immobili, newImmobile];
                }
                
                setImmobili(updatedImmobili);
                await saveData('immobili', updatedImmobili);
                closeModal();
            };

            const handleSaveInquilino = async (formData) => {
                const newInquilino = {
                    id: editingItem?.id || Date.now().toString(),
                    ...formData,
                    createdAt: editingItem?.createdAt || new Date().toISOString()
                };

                let updatedInquilini;
                if (editingItem) {
                    updatedInquilini = inquilini.map(i => i.id === editingItem.id ? newInquilino : i);
                } else {
                    updatedInquilini = [...inquilini, newInquilino];
                }
                
                setInquilini(updatedInquilini);
                await saveData('inquilini', updatedInquilini);
                closeModal();
            };

            const handleSavePagamento = async (formData) => {
                const newPagamento = {
                    id: editingItem?.id || Date.now().toString(),
                    ...formData,
                    createdAt: editingItem?.createdAt || new Date().toISOString()
                };

                let updatedPagamenti;
                if (editingItem) {
                    updatedPagamenti = pagamenti.map(p => p.id === editingItem.id ? newPagamento : p);
                } else {
                    updatedPagamenti = [...pagamenti, newPagamento];
                }
                
                setPagamenti(updatedPagamenti);
                await saveData('pagamenti', updatedPagamenti);
                closeModal();
            };

            const handleSaveSpesa = async (formData) => {
                const newSpesa = {
                    id: editingItem?.id || Date.now().toString(),
                    ...formData,
                    createdAt: editingItem?.createdAt || new Date().toISOString()
                };

                let updatedSpese;
                if (editingItem) {
                    updatedSpese = spese.map(s => s.id === editingItem.id ? newSpesa : s);
                } else {
                    updatedSpese = [...spese, newSpesa];
                }
                
                setSpese(updatedSpese);
                await saveData('spese', updatedSpese);
                closeModal();
            };

            const deleteItem = async (type, id) => {
                if (!confirm('Sei sicuro di voler eliminare questo elemento?')) return;

                if (type === 'immobile') {
                    const updated = immobili.filter(i => i.id !== id);
                    setImmobili(updated);
                    await saveData('immobili', updated);
                } else if (type === 'inquilino') {
                    const updated = inquilini.filter(i => i.id !== id);
                    setInquilini(updated);
                    await saveData('inquilini', updated);
                } else if (type === 'pagamento') {
                    const updated = pagamenti.filter(p => p.id !== id);
                    setPagamenti(updated);
                    await saveData('pagamenti', updated);
                } else if (type === 'spesa') {
                    const updated = spese.filter(s => s.id !== id);
                    setSpese(updated);
                    await saveData('spese', updated);
                }
            };

            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            const totaleAffittiMese = pagamenti
                .filter(p => {
                    if (!p.meseAnno) return false;
                    const date = new Date(p.meseAnno + '-01');
                    return date.getMonth() === currentMonth && date.getFullYear() === currentYear && p.stato === 'Pagato';
                })
                .reduce((sum, p) => sum + parseFloat(p.importoIncassato || 0), 0);

            const totaleSpeseMese = spese
                .filter(s => {
                    if (!s.dataSpesa) return false;
                    const date = new Date(s.dataSpesa);
                    return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
                })
                .reduce((sum, s) => sum + parseFloat(s.importo || 0), 0);

            const guadagnoNetto = totaleAffittiMese - totaleSpeseMese;
            const immobiliAffittati = immobili.filter(i => i.stato === 'Affittato').length;
            const immobiliLiberi = immobili.filter(i => i.stato === 'Libero').length;
            const pagamentiInRitardo = pagamenti.filter(p => p.stato === 'In ritardo').length;

            if (loading) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                            <p className="text-gray-600">Caricamento...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50">
                    <header className="bg-blue-600 text-white p-4 shadow-lg">
                        <h1 className="text-2xl font-bold">üè† Gestione Immobili Padula</h1>
                    </header>

                    <nav className="bg-white shadow-md sticky top-0 z-10">
                        <div className="flex overflow-x-auto">
                            {[
                                { id: 'dashboard', label: 'Dashboard', icon: 'üìä' },
                                { id: 'immobili', label: 'Immobili', icon: 'üè†' },
                                { id: 'inquilini', label: 'Inquilini', icon: 'üë•' },
                                { id: 'pagamenti', label: 'Pagamenti', icon: 'üí∞' },
                                { id: 'spese', label: 'Spese', icon: 'üí∏' }
                            ].map(tab => (
                                <button
                                    key={tab.id}
                                    onClick={() => setActiveTab(tab.id)}
                                    className={`flex items-center gap-2 px-4 py-3 whitespace-nowrap ${
                                        activeTab === tab.id ? 'bg-blue-50 text-blue-600 border-b-2 border-blue-600' : 'text-gray-600'
                                    }`}
                                >
                                    <span>{tab.icon}</span>
                                    {tab.label}
                                </button>
                            ))}
                        </div>
                    </nav>

                    <main className="p-4 max-w-7xl mx-auto">
                        {activeTab === 'dashboard' && (
                            <Dashboard
                                totaleAffittiMese={totaleAffittiMese}
                                totaleSpeseMese={totaleSpeseMese}
                                guadagnoNetto={guadagnoNetto}
                                immobiliAffittati={immobiliAffittati}
                                immobiliLiberi={immobiliLiberi}
                                pagamentiInRitardo={pagamentiInRitardo}
                                immobili={immobili}
                            />
                        )}

                        {activeTab === 'immobili' && (
                            <ListaGenerica
                                titolo="üè† Immobili"
                                items={immobili}
                                onAdd={() => openModal('immobile')}
                                onEdit={(item) => openModal('immobile', item)}
                                onDelete={(id) => deleteItem('immobile', id)}
                                type="immobile"
                            />
                        )}

                        {activeTab === 'inquilini' && (
                            <ListaGenerica
                                titolo="üë• Inquilini"
                                items={inquilini}
                                onAdd={() => openModal('inquilino')}
                                onEdit={(item) => openModal('inquilino', item)}
                                onDelete={(id) => deleteItem('inquilino', id)}
                                type="inquilino"
                            />
                        )}

                        {activeTab === 'pagamenti' && (
                            <ListaGenerica
                                titolo="üí∞ Pagamenti Affitti"
                                items={pagamenti}
                                onAdd={() => openModal('pagamento')}
                                onEdit={(item) => openModal('pagamento', item)}
                                onDelete={(id) => deleteItem('pagamento', id)}
                                type="pagamento"
                            />
                        )}

                        {activeTab === 'spese' && (
                            <ListaGenerica
                                titolo="üí∏ Spese"
                                items={spese}
                                totalSpese={spese.reduce((sum, s) => sum + parseFloat(s.importo || 0), 0)}
                                onAdd={() => openModal('spesa')}
                                onEdit={(item) => openModal('spesa', item)}
                                onDelete={(id) => deleteItem('spesa', id)}
                                type="spesa"
                            />
                        )}
                    </main>

                    {showModal && (
                        <Modal
                            type={modalType}
                            item={editingItem}
                            immobili={immobili}
                            inquilini={inquilini}
                            onClose={closeModal}
                            onSave={(data) => {
                                if (modalType === 'immobile') handleSaveImmobile(data);
                                else if (modalType === 'inquilino') handleSaveInquilino(data);
                                else if (modalType === 'pagamento') handleSavePagamento(data);
                                else if (modalType === 'spesa') handleSaveSpesa(data);
                            }}
                        />
                    )}
                </div>
            );
        };

        const Dashboard = ({ totaleAffittiMese, totaleSpeseMese, guadagnoNetto, immobiliAffittati, immobiliLiberi, pagamentiInRitardo, immobili }) => {
            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-bold text-gray-800">üìä Dashboard</h2>

                    {pagamentiInRitardo > 0 && (
                        <div className="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                            <div className="flex items-center gap-2">
                                <span className="text-2xl">‚ö†Ô∏è</span>
                                <div>
                                    <p className="font-semibold text-red-800">Attenzione!</p>
                                    <p className="text-red-700">{pagamentiInRitardo} pagamento{pagamentiInRitardo > 1 ? 'i' : ''} in ritardo</p>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div className="bg-white rounded-lg shadow p-6">
                            <p className="text-sm text-gray-600 mb-2">Affitti Mese</p>
                            <p className="text-2xl font-bold text-green-600">‚Ç¨{totaleAffittiMese.toFixed(2)}</p>
                        </div>
                        <div className="bg-white rounded-lg shadow p-6">
                            <p className="text-sm text-gray-600 mb-2">Spese Mese</p>
                            <p className="text-2xl font-bold text-red-600">‚Ç¨{totaleSpeseMese.toFixed(2)}</p>
                        </div>
                        <div className="bg-white rounded-lg shadow p-6">
                            <p className="text-sm text-gray-600 mb-2">Guadagno Netto</p>
                            <p className={`text-2xl font-bold ${guadagnoNetto >= 0 ? 'text-blue-600' : 'text-red-600'}`}>
                                ‚Ç¨{guadagnoNetto.toFixed(2)}
                            </p>
                        </div>
                        <div className="bg-white rounded-lg shadow p-6">
                            <p className="text-sm text-gray-600 mb-2">Immobili</p>
                            <p className="text-2xl font-bold text-purple-600">{immobiliAffittati} / {immobili.length}</p>
                            <p className="text-sm text-gray-500 mt-1">{immobiliLiberi} liberi</p>
                        </div>
                    </div>

                    <div>
                        <h3 className="text-xl font-semibold text-gray-800 mb-4">I Tuoi Immobili</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {immobili.map(immobile => {
                                const tipoColor = immobile.tipo === 'Appartamento' ? 'bg-blue-500' :
                                                immobile.tipo === 'Garage' ? 'bg-gray-500' : 'bg-orange-500';
                                const statoConfig = immobile.stato === 'Affittato' ? { emoji: 'üü¢', bg: 'bg-green-50', text: 'text-green-700' } :
                                                   immobile.stato === 'Libero' ? { emoji: 'üî¥', bg: 'bg-red-50', text: 'text-red-700' } :
                                                   { emoji: 'üü†', bg: 'bg-orange-50', text: 'text-orange-700' };
                                
                                return (
                                    <div key={immobile.id} className="bg-white rounded-lg shadow-md overflow-hidden">
                                        <div className={`h-2 ${tipoColor}`}></div>
                                        <div className="p-4">
                                            <div className="flex items-start justify-between mb-2">
                                                <h4 className="font-semibold text-gray-800 flex-1">{immobile.nome}</h4>
                                                <span className={`${statoConfig.bg} ${statoConfig.text} px-2 py-1 rounded text-xs font-medium`}>
                                                    {statoConfig.emoji} {immobile.stato}
                                                </span>
                                            </div>
                                            <p className="text-sm text-gray-600 mb-2">üìç {immobile.tipo}</p>
                                            {immobile.inquilino && <p className="text-sm text-gray-600 mb-2">üë§ {immobile.inquilino}</p>}
                                            <p className="text-lg font-bold text-blue-600">‚Ç¨{parseFloat(immobile.affittoMensile || 0).toFixed(2)}/mese</p>
                                        </div>
                                    </div>
                                );
                            })}
                            {immobili.length === 0 && (
                                <div className="col-span-full text-center py-12 text-gray-500">
                                    Nessun immobile ancora. Aggiungi il primo!
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const ListaGenerica = ({ titolo, items, totalSpese, onAdd, onEdit, onDelete, type }) => {
            return (
                <div className="space-y-4">
                    <div className="flex items-center justify-between">
                        <h2 className="text-2xl font-bold text-gray-800">{titolo}</h2>
                        <button
                            onClick={onAdd}
                            className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
                        >
                            ‚ûï Aggiungi
                        </button>
                    </div>

                    {type === 'spesa' && totalSpese !== undefined && (
                        <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                            <p className="text-sm text-blue-800">Totale Spese Registrate</p>
                            <p className="text-2xl font-bold text-blue-900">‚Ç¨{totalSpese.toFixed(2)}</p>
                        </div>
                    )}

                    <div className="bg-white rounded-lg shadow overflow-hidden">
                        {items.length === 0 ? (
                            <div className="text-center py-12 text-gray-500">
                                Nessun elemento ancora. Clicca su "Aggiungi"!
                            </div>
                        ) : (
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            {type === 'immobile' && (
                                                <>
                                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Nome</th>
                                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Tipo</th>
                                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Stato</th>
                                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Inquilino</th>
                                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Affitto</th>
                                                </>
                                            )}
                                            {type === 'inquilino' && (
                                                <>
                                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Nome</th>
                                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Immobile</th>
                                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Telefono</th>
                                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Email</th>
                                                </>
                                            )}
                                            {type === 'pagamento' && (
                                                <>
                                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Immobile</th>
                                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Mese</th>
                                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Previsto</th>
                                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Incassato</th>
                                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Stato</th>
                                                </>
                                            )}
                                            {type === 'spesa' && (
                                                <>
                                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Data</th>
                                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Immobile</th>
                                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Categoria</th>
                                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Descrizione</th>
                                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Importo</th>
                                                </>
                                            )}
                                            <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Azioni</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-200">
                                        {items.map(item => (
                                            <tr key={item.id} className="hover:bg-gray-50">
                                                {type === 'immobile' && (
                                                    <>
                                                        <td className="px-4 py-3 text-sm text-gray-800">{item.nome}</td>
                                                        <td className="px-4 py-3 text-sm text-gray-600">{item.tipo}</td>
                                                        <td className="px-4 py-3">
                                                            <span className={`px-2 py-1 rounded text-xs font-medium ${
                                                                item.stato === 'Affittato' ? 'bg-green-100 text-green-700' :
                                                                item.stato === 'Libero' ? 'bg-red-100 text-red-700' :
                                                                'bg-orange-100 text-orange-700'
                                                            }`}>{item.stato}</span>
                                                        </td>
                                                        <td className="px-4 py-3 text-sm text-gray-600">{item.inquilino || '-'}</td>
                                                        <td className="px-4 py-3 text-sm font-semibold">‚Ç¨{parseFloat(item.affittoMensile || 0).toFixed(2)}</td>
                                                    </>
                                                )}
                                                {type === 'inquilino' && (
                                                    <>
                                                        <td className="px-4 py-3 text-sm text-gray-800">{item.nome}</td>
                                                        <td className="px-4 py-3 text-sm text-gray-600">{item.immobile || '-'}</td>
                                                        <td className="px-4 py-3 text-sm text-gray-600">{item.telefono || '-'}</td>
                                                        <td className="px-4 py-3 text-sm text-gray-600">{item.email || '-'}</td>
                                                    </>
                                                )}
                                                {type === 'pagamento' && (
                                                    <>
                                                        <td className="px-4 py-3 text-sm text-gray-800">{item.immobile}</td>
                                                        <td className="px-4 py-3 text-sm text-gray-600">
                                                            {item.meseAnno ? new Date(item.meseAnno + '-01').toLocaleDateString('it-IT', { month: 'long', year: 'numeric' }) : '-'}
                                                        </td>
                                                        <td className="px-4 py-3 text-sm">‚Ç¨{parseFloat(item.importoPrevisto || 0).toFixed(2)}</td>
                                                        <td className="px-4 py-3 text-sm">‚Ç¨{parseFloat(item.importoIncassato || 0).toFixed(2)}</td>
                                                        <td className="px-4 py-3">
                                                            <span className={`px-2 py-1 rounded text-xs font-medium ${
                                                                item.sta
